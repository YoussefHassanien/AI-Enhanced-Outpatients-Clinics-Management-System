services:
  rabbitMq:
    image: rabbitmq:4.1.6-alpine
    container_name: message-queue
    ports:
      - 5672
    networks:
      - services-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
  auth:
    build:
      context: .
      dockerfile: ./apps/auth/Dockerfile
    env_file:
      - ./apps/auth/.env
    depends_on:
      - rabbitMq
    command: node auth/main
    networks:
      - services-network
    volumes:
      - ./logs:/app/logs

  api-gateway:
    build:
      context: .
      dockerfile: ./apps/api-gateway/Dockerfile
    env_file:
      - ./apps/api-gateway/.env
    ports:
      - 4000:4000
    depends_on:
      - rabbitMq
      - auth
      - doctor
    command: node api-gateway/main
    networks:
      - services-network
    volumes:
      - ./logs:/app/logs

  doctor:
    build:
      context: .
      dockerfile: ./apps/doctor/Dockerfile
    env_file:
      - ./apps/doctor/.env
    depends_on:
      - rabbitMq
    command: node doctor/main
    networks:
      - services-network
    volumes:
      - ./logs:/app/logs

  admin:
    build:
      context: .
      dockerfile: ./apps/admin/Dockerfile
    env_file:
      - ./apps/admin/.env
    depends_on:
      - rabbitMq
    command: node admin/main
    networks:
      - services-network
    volumes:
      - ./logs:/app/logs

  ocr-consumer:
    build:
      context: ./apps/ocr
      dockerfile: Dockerfile
    container_name: ocr-consumer
    env_file:
      - ./apps/ocr/.env
    depends_on:
      rabbitMq:
        condition: service_healthy
    command: ["python", "run_consumer.py"]
    networks:
      - services-network
    volumes:
      - logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 300s

networks:
  services-network:
    driver: bridge
